<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>QR Check</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 10px;
}
#reader {
    width: 300px;
    margin: auto;
}
#result {
    margin-top: 15px;
    font-size: 18px;
}
.ok { color: green; }
.cancel { color: red; }
</style>
</head>

<body>

<h2>Qu√©t QR Code</h2>

<div id="reader"></div>
<div id="result"></div>

<script>
const FIREBASE = "https://label-8de5d-default-rtdb.asia-southeast1.firebasedatabase.app";

function show(msg, cls="") {
    const el = document.getElementById("result");
    el.className = cls;
    el.innerHTML = msg;
}

function onScanSuccess(code) {
    html5QrCode.stop();

    fetch(`${FIREBASE}/qr/${code}.json`)
        .then(r => r.json())
        .then(data => {
            if (!data) {
                show("‚ùå Kh√¥ng t·ªìn t·∫°i m√£", "cancel");
                return;
            }
            //renderInfo(data);
            if (data.trang_thai === "ƒê√£ h·ªßy") {
                show(html, "cancel");
            } else {
                show(html, "ok");
            }
        })
        .catch(() => show("‚ö†Ô∏è L·ªói k·∫øt n·ªëi", "cancel"));
}

const html5QrCode = new Html5Qrcode("reader");
function calcRemain(expireStr) {
    // ƒë·ªïi "YYYY-MM-DD HH:MM" ‚Üí Date
    const expire = new Date(expireStr.replace(" ", "T"));
    const now = new Date();

    const diffMs = expire - now;

    if (diffMs <= 0) {
        return { text: "ƒê√É H·∫æT H·∫†N", expired: true };
    }

    const mins = Math.floor(diffMs / 60000);
    const days = Math.floor(mins / 1440);
    const hours = Math.floor((mins % 1440) / 60);
    const minutes = mins % 60;

    return {
        text: `C√≤n ${days} ng√†y ${hours} gi·ªù ${minutes} ph√∫t`,
        expired: false
    };
}
function renderInfo(data) {
    const hsd_ = data["Ng√†y h·∫øt h·∫°n"];
    const remain = calcRemain(hsd);

    let html = `
        <b>M√£ ƒëƒÉng k√Ω:</b> ${data["M√£ ƒëƒÉng k√Ω"]}<br>
        <b>T√™n Keo:</b> ${data["T√™n Keo"]}<br>
        <b>Model:</b> ${data["Model"]}<br>
        <b>C√¥ng ƒëo·∫°n:</b> ${data["C√¥ng ƒëo·∫°n"]}<br>
        <b>HSD:</b> ${data["HSD"]}<br>
        <b>Ng√†y nh·∫≠p:</b> ${data["Ng√†y nh·∫≠p"]}<br>
        <b>Ng√†y h·∫øt h·∫°n:</b> ${hsd_}<br>
        <b>Tr·∫°ng Th√°i:</b> ${data["Tr·∫°ng th√°i"]}<br>
        <b>Th·ªùi gian c√≤n l·∫°i:</b>
        <span class="${remain.expired ? 'expired' : 'valid'}">
            ${remain.text}
        </span>
    `;
    document.getElementById("info").innerHTML = html;
}

html5QrCode.start(
    { facingMode: "environment" }, // üëà CAM SAU
    { fps: 10, qrbox: 250 },
    onScanSuccess
);
</script>

</body>
</html>
