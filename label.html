<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>QR Check</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 10px;
}
button {
    padding: 10px 15px;
    margin: 5px;
    font-size: 16px;
}
#reader {
    width: 300px;
    margin: auto;
    display: none;
}
input {
    padding: 8px;
    width: 80%;
    font-size: 16px;
}
.ok { color: green; }
.cancel { color: red; }
.expired { color: red; font-weight: bold; }
.valid { color: green; }
</style>
</head>

<body>

<h2>Ki·ªÉm tra QR / M√£</h2>

<button onclick="startScan()">üì∑ Qu√©t QR</button>
<button onclick="showManual()">‚å® Nh·∫≠p m√£</button>

<div id="reader"></div>

<div id="manual" style="display:none;">
    <input id="manualCode" placeholder="Nh·∫≠p m√£ ƒëƒÉng k√Ω">
    <br><br>
    <button onclick="checkManual()">Ki·ªÉm tra</button>
</div>

<hr>

<div id="result"></div>

<script>
const FIREBASE = "https://label-8de5d-default-rtdb.asia-southeast1.firebasedatabase.app";
let html5QrCode;

/* ================= TI·ªÜN √çCH ================= */

function show(msg, cls="") {
    const el = document.getElementById("result");
    el.className = cls;
    el.innerHTML = msg;
}

function calcRemain(expireStr) {
    const expire = new Date(expireStr.replace(" ", "T"));
    const now = new Date();
    const diff = expire - now;

    if (diff <= 0) {
        return { text: "ƒê√É H·∫æT H·∫†N", expired: true };
    }

    const mins = Math.floor(diff / 60000);
    const days = Math.floor(mins / 1440);
    const hours = Math.floor((mins % 1440) / 60);

    return {
        text: `C√≤n ${days} ng√†y ${hours} gi·ªù`,
        expired: false
    };
}

/* ================= HI·ªÇN TH·ªä ================= */

function renderInfo(data) {
    const hsd = data["Ng√†y h·∫øt h·∫°n"];
    const remain = calcRemain(hsd);

    const remainHtml = data["Tr·∫°ng th√°i"] === "ƒê√£ h·ªßy"
        ? `<span class="expired">ƒê√É H·ª¶Y</span>`
        : `<span class="${remain.expired ? 'expired' : 'valid'}">${remain.text}</span>`;

    return `
        <b>M√£ ƒëƒÉng k√Ω:</b> ${data["M√£ ƒëƒÉng k√Ω"]}<br>
        <b>T√™n Keo:</b> ${data["T√™n Keo"]}<br>
        <b>Model:</b> ${data["Model"]}<br>
        <b>C√¥ng ƒëo·∫°n:</b> ${data["C√¥ng ƒëo·∫°n"]}<br>
        <b>HSD:</b> ${data["HSD"]}<br>
        <b>Ng√†y nh·∫≠p:</b> ${data["Ng√†y nh·∫≠p"]}<br>
        <b>Ng√†y h·∫øt h·∫°n:</b> ${hsd}<br>
        <b>Tr·∫°ng th√°i:</b> ${data["Tr·∫°ng th√°i"]}<br>
        <b>Th·ªùi gian c√≤n l·∫°i:</b> ${remainHtml}
    `;
}

/* ================= CHECK DATA ================= */

function checkCode(code) {
    show("‚è≥ ƒêang ki·ªÉm tra...");

    fetch(`${FIREBASE}/qr/${code}.json`)
        .then(r => r.json())
        .then(data => {
            if (!data) {
                show("‚ùå Kh√¥ng t·ªìn t·∫°i m√£", "cancel");
                return;
            }
            show(renderInfo(data),
                 data["Tr·∫°ng th√°i"] === "ƒê√£ h·ªßy" ? "cancel" : "ok");
        })
        .catch(() => show("‚ö†Ô∏è L·ªói k·∫øt n·ªëi", "cancel"));
}

/* ================= QR ================= */

function startScan() {
    document.getElementById("reader").style.display = "block";
    document.getElementById("manual").style.display = "none";

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        code => {
            html5QrCode.stop();
            checkCode(code);
        }
    );
}

/* ================= NH·∫¨P TAY ================= */

function showManual() {
    document.getElementById("reader").style.display = "none";
    document.getElementById("manual").style.display = "block";
}

function checkManual() {
    const code = document.getElementById("manualCode").value.trim();
    if (!code) {
        alert("Nh·∫≠p m√£ tr∆∞·ªõc ƒë√£!");
        return;
    }
    checkCode(code);
}
</script>

</body>
</html>
