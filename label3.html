<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>QR Check 1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 10px;
}
button {
    padding: 10px 15px;
    margin: 5px;
    font-size: 16px;
}
#reader {
    width: 300px;
    margin: auto;
    display: none;
}
input {
    padding: 8px;
    width: 200px;
    font-size: 16px;
}
.ok { color: green; }
.cancel { color: red; }
.expired { color: red; font-weight: bold; }
.valid { color: green; }
</style>
</head>

<body>

<h2>Check Label Epoxy/Grease x∆∞·ªüng 3 t·∫ßng 3</h2>
Nt.Anh@Jahwa.co.kr - Zalo 0975.440.422<br>
    -----------------------------
<br>
<button onclick="startScan()">üì∑ Qu√©t QR</button>
<button onclick="showManual()">‚å® Nh·∫≠p m√£</button>
<button onclick="loadNearExpire()">üìã Xem danh s√°ch s·∫Øp h·∫øt h·∫°n</button>

<div id="reader"></div>

<div id="manual" style="display:none;">
    <input id="manualCode" placeholder="Nh·∫≠p m√£ ƒëƒÉng k√Ω">
    <br><br>
    <button onclick="checkManual()">Ki·ªÉm tra</button>
</div>

<hr>

<div id="result"></div>

<script>
const FIREBASE = "https://x3t3-6a234-default-rtdb.asia-southeast1.firebasedatabase.app";
let html5QrCode;

/* ================= TI·ªÜN √çCH ================= */

function show(msg, cls="") {
    const el = document.getElementById("result");
    el.className = cls;
    el.innerHTML = msg;
}

function calcRemain(expireStr) {
    const expire = new Date(expireStr.replace(" ", "T"));
    const now = new Date();
    const diff = expire - now;

    if (diff <= 0) {
        return { text: "ƒê√É H·∫æT H·∫†N", expired: true };
    }

    const mins = Math.floor(diff / 60000);
    const days = Math.floor(mins / 1440);
    const hours = Math.floor((mins % 1440) / 60);

    return {
        text: `C√≤n ${days} ng√†y ${hours} gi·ªù`,
        expired: false
    };
}

/* ================= HI·ªÇN TH·ªä ================= */

function renderInfo(data) {
    const hsd = data["Ng√†y h·∫øt h·∫°n"];
    const remain = calcRemain(hsd);

    const remainHtml = data["Tr·∫°ng th√°i"] === "ƒê√£ h·ªßy"
        ? `<span class="expired">ƒê√É H·ª¶Y</span>`
        : `<span class="${remain.expired ? 'expired' : 'valid'}">${remain.text}</span>`;

    return `
        <b>M√£ ƒëƒÉng k√Ω:</b> ${data["M√£ ƒëƒÉng k√Ω"]}<br>
        <b>T√™n Keo:</b> ${data["T√™n Keo"]}<br>
        <b>Model:</b> ${data["Model"]}<br>
        <b>C√¥ng ƒëo·∫°n:</b> ${data["C√¥ng ƒëo·∫°n"]}<br>
        <b>HSD:</b> ${data["HSD"]}<br>
        <b>Ng√†y nh·∫≠p:</b> ${data["Ng√†y nh·∫≠p"]}<br>
        <b>Ng√†y h·∫øt h·∫°n:</b> ${hsd}<br>
        <b>Tr·∫°ng th√°i:</b> ${data["Tr·∫°ng th√°i"]}<br>
        <b>Th·ªùi gian c√≤n l·∫°i:</b> ${remainHtml}
    `;
}

/* ================= CHECK DATA ================= */

function checkCode(code) {
    show("‚è≥ ƒêang ki·ªÉm tra...");

    fetch(`${FIREBASE}/qr_X3T1_master/${code}.json`)
        .then(r => r.json())
        .then(data => {
            if (!data) {
                show("‚ùå Kh√¥ng t·ªìn t·∫°i m√£", "cancel");
                return;
            }
            show(renderInfo(data),
                 data["Tr·∫°ng th√°i"] === "ƒê√£ h·ªßy" ? "cancel" : "ok");
        })
        .catch(() => show("‚ö†Ô∏è L·ªói k·∫øt n·ªëi", "cancel"));
}

/* ================= QR ================= */

function startScan() {
    document.getElementById("reader").style.display = "block";
    document.getElementById("manual").style.display = "none";

    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }

    html5QrCode.start(
        { facingMode: "environment" },   // üëà CH·ªà 1 KEY
        {
            fps: 10,
            qrbox: { width: 350, height: 350 } // üëà OK
        },
        code => {
            html5QrCode.stop();
            checkCode(code);
        },
        err => {
            // console.warn(err); // debug n·∫øu c·∫ßn
        }
    );
}



/* ================= NH·∫¨P TAY ================= */

function showManual() {
    document.getElementById("reader").style.display = "none";
    document.getElementById("manual").style.display = "block";
}

function checkManual() {
    const code = document.getElementById("manualCode").value.trim();
    if (!code) {
        alert("Nh·∫≠p m√£ tr∆∞·ªõc ƒë√£!");
        return;
    }
    checkCode(code);
}

function remainHours(expireStr) {
    const expire = new Date(expireStr.replace(" ", "T"));
    const now = new Date();
    return (expire - now) / 3600000; // gi·ªù
}
function formatRemain(hours) {
    if (hours <= 0) return "ƒê√£ h·∫øt h·∫°n";

    const totalMinutes = Math.floor(hours * 60);

    const days = Math.floor(totalMinutes / 1440);
    const hoursLeft = Math.floor((totalMinutes % 1440) / 60);
    const minutes = totalMinutes % 60;

    let parts = [];
    if (days > 0) parts.push(`${days} ng√†y`);
    if (hoursLeft > 0) parts.push(`${hoursLeft} gi·ªù`);
    parts.push(`${minutes} ph√∫t`);

    return parts.join(" ");
}

function loadNearExpire() {
    fetch(`${FIREBASE}/qr_X3T1_master.json`)
        .then(r => r.json())
        .then(data => {
            if (!data) return;

            const near5h = [];
            const future = [];

            Object.values(data).forEach(item => {
                if (!item["Ng√†y h·∫øt h·∫°n"]) return;
                if (item["Tr·∫°ng th√°i"] === "ƒê√£ h·ªßy") return;

                const expire = new Date(item["Ng√†y h·∫øt h·∫°n"].replace(" ", "T"));
                const now = new Date();
                const diffMs = expire - now;
                if (diffMs <= 0) return;

                const hours = diffMs / 3600000;

                const record = {
                    ma: item["M√£ ƒëƒÉng k√Ω"],
                    keo: item["T√™n Keo"],
                    model: item["Model"],
                    cong_doan: item["C√¥ng ƒëo·∫°n"],
                    hsd: item["Ng√†y h·∫øt h·∫°n"],
                    remain: formatRemain(hours),
                    diffMs
                };

                if (hours <= 5) {
                    near5h.push(record);
                } else {
                    future.push(record);
                }
            });

            let result;

            if (near5h.length > 0) {
                result = near5h;
            } else {
                // L·∫•y 10 h·∫°n g·∫ßn nh·∫•t
                future.sort((a, b) => a.diffMs - b.diffMs);
                result = future.slice(0, 30);
            }

            renderTable(result);
        })
        .catch(err => {
            console.error(err);
            show("‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu", "cancel");
        });
}

function renderTable(rows) {
    if (rows.length === 0) {
        show("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá", "cancel");
        return;
    }

    const title = rows.length <= 10
        ? "üìå 10 m√£ c√≥ h·∫°n g·∫ßn nh·∫•t"
        : "‚ö†Ô∏è Danh s√°ch s·∫Øp h·∫øt h·∫°n (‚â§ 5 gi·ªù)";

    let html = `
        <h3>${title}</h3>
        <table border="1" cellpadding="6" cellspacing="0" style="margin:auto;">
            <tr style="background:#fdd;">
                <th>M√£</th>
                <th>T√™n keo</th>
                <th>Model</th>
                <th>C√¥ng ƒëo·∫°n</th>
                <th>H·∫øt h·∫°n</th>
                <th>Th·ªùi gian c√≤n l·∫°i</th>
            </tr>
    `;

    rows.forEach(r => {
        html += `
            <tr>
                <td>${r.ma}</td>
                <td>${r.keo}</td>
                <td>${r.model}</td>
                <td>${r.cong_doan}</td>
                <td>${r.hsd}</td>
                <td style="color:red;font-weight:bold">${r.remain}</td>
            </tr>
        `;
    });

    html += "</table>";
    document.getElementById("result").innerHTML = html;
}

</script>

</body>
</html>
